---
title: 讲讲 Redis 缓存更新一致性
subtitle: 讲讲 Redis 缓存更新一致性
category:
  - redis
tag:
  - 摸鱼
order: 2
---
## 在使用redis作为缓存时,写操作
当执行写操作后，因为需要保证从缓存读取到的数据与数据库中的数据是一致的，这就需要对缓存进行更新。
## 旧key 是删除还是更新？缓存和数据库的更新顺序？

## 删除缓存
### 先删除缓存，再更新数据库
- 并发问题:
>>写： 线程张三  
>>读： 线程李四

|顺序|线程:张三|线程:李四|数据库|缓存|
|:----|:----:|----:|----:|----:|
|1|删除缓存||v1||
|2||缓存失效|v1||
|3||从数据库读取数据为v1|v1||
|4|更新数据库为v2||v2||
|5||将v1写入缓存|v2|v1|

### 先更新数据库，再删除缓存
1. 若数据库更新成功，删除缓存操作失败，则此后读到的都是缓存中过期的数据，造成不一致问题。
2. 并发问题:
>>读： 线程张三  
>>写： 线程李四

|顺序|线程:张三|线程:李四|数据库|缓存|
|:----|:----:|----:|----:|----:|
|1|缓存失效||v1||
|2|从数据库读取数据为v1||v1||
|3||更新数据库|v2||
|4||删除缓存|v2||
|5|写入缓存||v2|v1|

## 更新缓存
### 先更新缓存，再更新数据库
1. 缓存更新成功，数据库有更新失败的风险；导致最新的数据未持久化，风险很高。
2. 并发问题。  

|顺序|线程:张三|线程:李四|数据库|缓存|
|:----|:----:|----:|----:|----:|
|1|||v0|v0|
|2|更新缓存为v1||v0|v1|
|3||更新缓存为v2|v0|v2|
|4||更新数据库为v2|v2|v2|
|5|更新数据库为v1||v1|v2|

### 先更新数据库，再更新缓存
1. 同删除缓存策略一样，若数据库更新成功缓存更新失败则会造成数据不一致问题。
2. 并发问题。 

|顺序|线程:张三|线程:李四|数据库|缓存|
|:----|:----:|----:|----:|----:|
|1|||v0|v0|
|2|更新缓存为v1||v1|v0|
|3||更新缓存为v2|v2|v0|
|4||更新数据库为v2|v2|v2|
|5|更新数据库为v1||v2|v1|

## 对于旧key,目前已知的两种策略
1. 删除失效缓存: 读取时会因为未命中缓存而从数据库中读取新的数据并更新到缓存中
2. 更新缓存: 直接将新的数据写入缓存覆盖过期数据
## 更新缓存和数据库的前后顺序，也有两种
1. 先数据库后缓存
2. 先缓存后数据库
## 
根据实际场景选择一款就行，折中
